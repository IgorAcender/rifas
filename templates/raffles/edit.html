{% extends 'base.html' %}
{% load static %}

{% block title %}Editar campanha | Sistema de Rifas{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header-left">
        <svg class="header-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
        </svg>
        <h1>Editar campanha</h1>
    </div>
    <a href="{% url 'raffle_list' %}" class="btn-voltar">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
        Voltar
    </a>
</div>

<div class="form-container">
    <div class="form-steps">
        <div class="step active">
            <div class="step-number">1</div>
            <span>Informacoes</span>
        </div>
        <div class="step">
            <div class="step-number">2</div>
            <span>Imagens</span>
        </div>
        <div class="step">
            <div class="step-number">3</div>
            <span>Configuracoes</span>
        </div>
    </div>

    <form method="post" class="raffle-form" enctype="multipart/form-data">
        {% csrf_token %}

        <div class="form-section active" data-step="1">
            <h2>Informacoes</h2>

            <div class="form-row">
                <div class="form-group full-width">
                    <label for="name">Nome da campanha</label>
                    <input
                        type="text"
                        id="name"
                        name="name"
                        value="{{ raffle.name }}"
                        placeholder="Informe o nome da sua campanha"
                        required
                    >
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="total_numbers">Quantidade de titulos</label>
                    <select id="total_numbers" name="total_numbers">
                        <option value="{{ raffle.total_numbers }}" selected>{{ raffle.total_numbers }} titulos (atual)</option>
                        {% if raffle.total_numbers < 100 %}
                        <option value="100">100 titulos</option>
                        {% endif %}
                        {% if raffle.total_numbers < 200 %}
                        <option value="200">200 titulos</option>
                        {% endif %}
                        {% if raffle.total_numbers < 500 %}
                        <option value="500">500 titulos</option>
                        {% endif %}
                        {% if raffle.total_numbers < 1000 %}
                        <option value="1000">1.000 titulos</option>
                        {% endif %}
                        {% if raffle.total_numbers < 2000 %}
                        <option value="2000">2.000 titulos</option>
                        {% endif %}
                        {% if raffle.total_numbers < 5000 %}
                        <option value="5000">5.000 titulos</option>
                        {% endif %}
                        {% if raffle.total_numbers < 10000 %}
                        <option value="10000">10.000 titulos</option>
                        {% endif %}
                        {% if raffle.total_numbers < 20000 %}
                        <option value="20000">20.000 titulos</option>
                        {% endif %}
                    </select>
                    <span class="field-hint">✅ Voce pode AUMENTAR a quantidade (novos numeros serao criados)</span>
                    <span class="field-hint">❌ Nao e possivel REDUZIR</span>
                </div>

                <div class="form-group">
                    <label for="price_per_number">Valor de cada titulo</label>
                    <div class="input-group">
                        <span class="input-prefix">R$</span>
                        <input
                            type="number"
                            id="price_per_number"
                            name="price_per_number"
                            value="{{ raffle.price_per_number }}"
                            step="0.01"
                            min="0.01"
                            placeholder="0,00"
                            required
                        >
                    </div>
                </div>

                <div class="form-group">
                    <label for="fee_percentage">Taxa (%)</label>
                    <div class="input-group">
                        <input
                            type="number"
                            id="fee_percentage"
                            name="fee_percentage"
                            value="{{ raffle.fee_percentage }}"
                            step="0.01"
                            min="0"
                            max="100"
                            placeholder="0,00"
                        >
                        <span class="input-suffix">%</span>
                    </div>
                    <small class="input-help">Porcentagem de taxa sobre o valor arrecadado (ex: 5.00 para 5%)</small>
                </div>
            </div>

            <div class="estimate-box">
                <p class="estimate-text">A sua arrecadacao estimada e de: <strong class="estimate-value">--</strong></p>
                <p class="tax-text">Taxa: <strong class="tax-value">--</strong></p>
                <a href="#" class="tax-link">Ver tabela de taxa →</a>
            </div>

            <button type="button" class="btn-primary btn-next" onclick="nextStep(2)">
                Continuar →
            </button>
        </div>

        <div class="form-section" data-step="2">
            <h2>Imagens</h2>

            <div class="form-row">
                <div class="form-group full-width">
                    <label for="prize_name">Nome do premio</label>
                    <input
                        type="text"
                        id="prize_name"
                        name="prize_name"
                        value="{{ raffle.prize_name }}"
                        placeholder="Ex: iPhone 15 Pro Max"
                        required
                    >
                </div>
            </div>

            <div class="form-row">
                <div class="form-group full-width">
                    <label for="prize_description">Descricao do premio</label>
                    <textarea
                        id="prize_description"
                        name="prize_description"
                        rows="4"
                        placeholder="Descreva o premio que sera sorteado..."
                    >{{ raffle.prize_description }}</textarea>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group full-width">
                    <label for="prize_image">Imagem do premio</label>
                    <div class="file-upload-box">
                        <input type="file" id="prize_image" name="prize_image" accept="image/*" onchange="previewImage(this)">
                        <div class="upload-placeholder" {% if raffle.prize_image_base64 %}style="display: none;"{% endif %}>
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                <polyline points="21 15 16 10 5 21"></polyline>
                            </svg>
                            <p>Clique para fazer upload da imagem</p>
                            <span class="upload-hint">PNG, JPG ou JPEG (max. 5MB)</span>
                        </div>
                        {% if raffle.prize_image_base64 %}
                        <img class="image-preview" src="data:image/jpeg;base64,{{ raffle.prize_image_base64 }}" style="display: block;">
                        {% else %}
                        <img class="image-preview" style="display: none;">
                        {% endif %}
                    </div>
                    <span class="field-hint">Deixe em branco para manter a imagem atual</span>
                </div>
            </div>

            <div class="form-actions">
                <button type="button" class="btn-secondary" onclick="prevStep(1)">
                    ← Voltar
                </button>
                <button type="button" class="btn-primary btn-next" onclick="nextStep(3)">
                    Continuar →
                </button>
            </div>
        </div>

        <div class="form-section" data-step="3">
            <h2>Configuracoes</h2>

            <div class="form-row">
                <div class="form-group full-width">
                    <label for="description">Descricao da campanha</label>
                    <textarea
                        id="description"
                        name="description"
                        rows="4"
                        placeholder="Descreva sua campanha..."
                    >{{ raffle.description }}</textarea>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="draw_date">Data do sorteio</label>
                    <input
                        type="datetime-local"
                        id="draw_date"
                        name="draw_date"
                        value="{{ raffle.draw_date|date:'Y-m-d\TH:i' }}"
                    >
                </div>

                <div class="form-group">
                    <label for="status">Status</label>
                    <select id="status" name="status">
                        <option value="draft" {% if raffle.status == 'draft' %}selected{% endif %}>Rascunho</option>
                        <option value="active" {% if raffle.status == 'active' %}selected{% endif %}>Ativa</option>
                        <option value="completed" {% if raffle.status == 'completed' %}selected{% endif %}>Concluida</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="inviter_bonus">Bonus do indicante</label>
                    <input
                        type="number"
                        id="inviter_bonus"
                        name="inviter_bonus"
                        value="{{ raffle.inviter_bonus }}"
                        min="0"
                    >
                    <span class="field-hint">Numeros gratis para quem indica</span>
                </div>

                <div class="form-group">
                    <label for="invitee_bonus">Bonus do indicado</label>
                    <input
                        type="number"
                        id="invitee_bonus"
                        name="invitee_bonus"
                        value="{{ raffle.invitee_bonus }}"
                        min="0"
                    >
                    <span class="field-hint">Numeros gratis para quem foi indicado</span>
                </div>
            </div>

            <div class="form-actions">
                <button type="button" class="btn-secondary" onclick="prevStep(2)">
                    ← Voltar
                </button>
                <button type="submit" class="btn-primary">
                    Salvar alteracoes
                </button>
            </div>
        </div>
    </form>
</div>

<script>
// Inicializar calculo da arrecadacao
document.addEventListener('DOMContentLoaded', function() {
    const totalNumbersSelect = document.getElementById('total_numbers');
    const priceInput = document.getElementById('price_per_number');

    function calculateEstimate() {
        const totalNumbers = parseInt(totalNumbersSelect.value) || 0;
        const price = parseFloat(priceInput.value) || 0;
        const total = totalNumbers * price;

        // Simple tax calculation (same as create form)
        let tax = 0;
        if (total <= 1000) tax = total * 0.05;
        else if (total <= 5000) tax = total * 0.04;
        else tax = total * 0.03;

        const estimate = total - tax;

        document.querySelector('.estimate-value').textContent =
            'R$ ' + estimate.toLocaleString('pt-BR', {minimumFractionDigits: 2});
        document.querySelector('.tax-value').textContent =
            'R$ ' + tax.toLocaleString('pt-BR', {minimumFractionDigits: 2});
    }

    totalNumbersSelect.addEventListener('change', calculateEstimate);
    priceInput.addEventListener('input', calculateEstimate);
    calculateEstimate();
});
</script>

<style>
.disabled-input {
    background: #f1f5f9;
    color: #94a3b8;
    cursor: not-allowed;
}

.field-hint {
    display: block;
    font-size: 12px;
    color: #64748b;
    margin-top: 4px;
}
</style>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/raffle-form.js' %}"></script>
{% endblock %}
