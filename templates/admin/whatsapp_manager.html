{% extends "base.html" %}

{% block title %}Gerenciador WhatsApp | Sistema de Rifas{% endblock %}

{% block extra_css %}
<style>
    .whatsapp-manager {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
    }

    .status-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
    }

    .status-indicator.connected {
        background-color: #4CAF50;
        box-shadow: 0 0 8px rgba(76, 175, 80, 0.6);
    }

    .status-indicator.disconnected {
        background-color: #F44336;
        box-shadow: 0 0 8px rgba(244, 67, 54, 0.6);
    }

    .status-indicator.loading {
        background-color: #FFC107;
        animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .qrcode-container {
        text-align: center;
        padding: 30px;
        background: #f5f5f5;
        border-radius: 8px;
        margin: 20px 0;
    }

    .qrcode-container img {
        max-width: 300px;
        border: 4px solid #fff;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .action-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 20px;
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s;
    }

    .btn-primary {
        background-color: #25D366;
        color: white;
    }

    .btn-primary:hover {
        background-color: #1da851;
    }

    .btn-secondary {
        background-color: #128C7E;
        color: white;
    }

    .btn-secondary:hover {
        background-color: #0d6d63;
    }

    .btn-danger {
        background-color: #dc3545;
        color: white;
    }

    .btn-danger:hover {
        background-color: #c82333;
    }

    .btn-warning {
        background-color: #ffc107;
        color: #000;
    }

    .btn-warning:hover {
        background-color: #e0a800;
    }

    .test-message-form {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-top: 20px;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
    }

    .form-group input,
    .form-group textarea {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }

    .form-group textarea {
        resize: vertical;
        min-height: 80px;
    }

    .alert {
        padding: 12px 20px;
        border-radius: 4px;
        margin-bottom: 20px;
    }

    .alert-success {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
    }

    .alert-error {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }

    .alert-warning {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
    }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }

    .info-item {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        border-left: 4px solid #25D366;
    }

    .info-label {
        font-size: 12px;
        color: #666;
        margin-bottom: 5px;
    }

    .info-value {
        font-size: 16px;
        font-weight: 600;
        color: #333;
        word-break: break-all;
    }

    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(0, 0, 0, 0.1);
        border-top-color: #25D366;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .hidden {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="whatsapp-manager">
    <h1>Gerenciador WhatsApp Evolution API</h1>

    <div id="alert-container"></div>

    {% if not api_configured %}
    <div class="alert alert-warning">
        <strong>AtenÃ§Ã£o!</strong> Evolution API nÃ£o estÃ¡ configurada. Verifique as variÃ¡veis de ambiente EVOLUTION_API_URL e EVOLUTION_API_KEY.
    </div>
    {% else %}

    <!-- Status Card -->
    <div class="status-card">
        <h2>Status da ConexÃ£o</h2>
        <div>
            <span class="status-indicator loading" id="status-indicator"></span>
            <span id="status-text">Verificando...</span>
        </div>

        <div class="info-grid">
            <div class="info-item">
                <div class="info-label">URL da API</div>
                <div class="info-value">{{ evolution_url }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">InstÃ¢ncia</div>
                <div class="info-value">{{ instance_name }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Estado</div>
                <div class="info-value" id="connection-state">-</div>
            </div>
        </div>

        <div class="action-buttons">
            <button class="btn btn-primary" onclick="checkStatus()">
                ğŸ”„ Atualizar Status
            </button>
            <button class="btn btn-secondary" onclick="showQRCode()">
                ğŸ“± Mostrar QR Code
            </button>
            <button class="btn btn-warning" onclick="restartInstance()">
                ğŸ”„ Reiniciar InstÃ¢ncia
            </button>
            <button class="btn btn-danger" onclick="logoutInstance()">
                ğŸšª Desconectar WhatsApp
            </button>
        </div>
    </div>

    <!-- QR Code Card -->
    <div class="status-card hidden" id="qrcode-card">
        <h2>QR Code para ConexÃ£o</h2>
        <p>Escaneie este QR Code com o WhatsApp do seu celular</p>
        <div class="qrcode-container">
            <img id="qrcode-image" src="" alt="QR Code">
        </div>
        <p style="text-align: center; color: #666;">
            O QR Code expira em 30 segundos. Clique em "Mostrar QR Code" para gerar um novo.
        </p>
    </div>

    <!-- Test Message Form -->
    <div class="test-message-form">
        <h2>Enviar Mensagem de Teste</h2>
        <form id="test-form" onsubmit="sendTestMessage(event)">
            {% csrf_token %}
            <div class="form-group">
                <label for="phone">NÃºmero do WhatsApp (com cÃ³digo do paÃ­s)</label>
                <input type="text" id="phone" name="phone" placeholder="5511999999999" required>
            </div>
            <div class="form-group">
                <label for="message">Mensagem</label>
                <textarea id="message" name="message" placeholder="Digite sua mensagem...">OlÃ¡! Esta Ã© uma mensagem de teste do sistema de rifas. ğŸ‰</textarea>
            </div>
            <button type="submit" class="btn btn-primary">ğŸ“¤ Enviar Mensagem</button>
        </form>
    </div>

    <!-- Message Template Editor -->
    <div class="test-message-form">
        <h2>ğŸ“ Editor de Mensagem de ConfirmaÃ§Ã£o</h2>
        <p style="color: #666; margin-bottom: 15px;">
            Esta mensagem serÃ¡ enviada automaticamente quando um pagamento for aprovado.
        </p>

        <div class="alert alert-warning" style="margin-bottom: 15px;">
            <strong>Placeholders disponÃ­veis:</strong><br>
            <code>{name}</code> - Nome do comprador<br>
            <code>{raffle_name}</code> - Nome da rifa<br>
            <code>{prize_name}</code> - Nome do prÃªmio<br>
            <code>{draw_date}</code> - Data do sorteio<br>
            <code>{numbers}</code> - NÃºmeros da sorte<br>
            <code>{amount}</code> - Valor pago<br>
            <code>{order_id}</code> - ID do pedido
        </div>

        <form id="template-form" onsubmit="saveTemplate(event, 'payment_confirmation')">
            {% csrf_token %}
            <div class="form-group">
                <label for="template">Template da Mensagem</label>
                <textarea id="template" name="template" rows="20" style="font-family: monospace;">{{ message_template }}</textarea>
            </div>
            <div style="display: flex; gap: 10px;">
                <button type="submit" class="btn btn-primary">ğŸ’¾ Salvar Template</button>
                <button type="button" class="btn btn-secondary" onclick="resetTemplate('payment_confirmation')">ğŸ”„ Restaurar PadrÃ£o</button>
            </div>
        </form>
    </div>

    <!-- Referral Bonus Template Editor -->
    <div class="test-message-form" style="margin-top: 30px;">
        <h2>ğŸ Editor de Mensagem de BÃ´nus de IndicaÃ§Ã£o</h2>
        <p style="color: #666; margin-bottom: 15px;">
            Esta mensagem serÃ¡ enviada automaticamente para o indicador quando alguÃ©m comprar com seu link.
        </p>

        <div class="alert alert-warning" style="margin-bottom: 15px;">
            <strong>Placeholders disponÃ­veis:</strong><br>
            <code>{inviter_name}</code> - Nome do indicador<br>
            <code>{invitee_name}</code> - Nome de quem comprou<br>
            <code>{raffle_name}</code> - Nome da campanha<br>
            <code>{invitee_quantity}</code> - Quantidade de nÃºmeros comprados<br>
            <code>{total_bonus}</code> - Total de nÃºmeros de bÃ´nus ganhos<br>
            <code>{bonus_breakdown}</code> - Detalhamento do bÃ´nus (base + progressivo)<br>
            <code>{bonus_numbers}</code> - Lista dos nÃºmeros de bÃ´nus
        </div>

        <form id="referral-template-form" onsubmit="saveTemplate(event, 'referral_bonus_notification')">
            {% csrf_token %}
            <div class="form-group">
                <label for="referral_template">Template da Mensagem</label>
                <textarea id="referral_template" name="template" rows="20" style="font-family: monospace;">{{ referral_bonus_template }}</textarea>
            </div>
            <div style="display: flex; gap: 10px;">
                <button type="submit" class="btn btn-primary">ğŸ’¾ Salvar Template</button>
                <button type="button" class="btn btn-secondary" onclick="resetTemplate('referral_bonus_notification')">ğŸ”„ Restaurar PadrÃ£o</button>
            </div>
        </form>
    </div>

    <!-- Referral Share Invitation Template Editor -->
    <div class="test-message-form" style="margin-top: 30px;">
        <h2>ğŸ“² Editor de Convite para Compartilhar IndicaÃ§Ã£o</h2>
        <p style="color: #666; margin-bottom: 15px;">
            Esta mensagem serÃ¡ enviada automaticamente apÃ³s a confirmaÃ§Ã£o de pagamento, convidando o comprador a compartilhar seu link de indicaÃ§Ã£o.
        </p>

        <div class="alert alert-warning" style="margin-bottom: 15px;">
            <strong>Placeholders disponÃ­veis:</strong><br>
            <code>{name}</code> - Nome do comprador<br>
            <code>{raffle_name}</code> - Nome da campanha<br>
            <code>{prize_name}</code> - Nome do prÃªmio<br>
            <code>{inviter_bonus}</code> - NÃºmeros que o indicador ganha<br>
            <code>{invitee_bonus}</code> - NÃºmeros que o indicado ganha<br>
            <code>{progressive_message}</code> - Mensagem sobre bÃ´nus progressivo (se ativado)<br>
            <code>{referral_link}</code> - Link de indicaÃ§Ã£o do usuÃ¡rio<br>
            <code>{successful_referrals}</code> - Quantidade de indicaÃ§Ãµes bem-sucedidas<br>
            <code>{total_bonus_earned}</code> - Total de nÃºmeros de bÃ´nus ganhos
        </div>

        <form id="referral-share-template-form" onsubmit="saveTemplate(event, 'referral_share_invitation')">
            {% csrf_token %}
            <div class="form-group">
                <label for="referral_share_delay">â±ï¸ Delay antes de enviar (segundos)</label>
                <input 
                    type="number" 
                    id="referral_share_delay" 
                    name="delay_seconds" 
                    value="{{ referral_share_delay }}" 
                    min="0" 
                    max="300"
                    style="width: 150px; padding: 8px; border: 1px solid #ddd; border-radius: 6px;"
                >
                <span style="color: #666; font-size: 13px; margin-left: 10px;">
                    Tempo de espera antes de enviar esta mensagem (0-300 segundos)
                </span>
            </div>
            <div class="form-group">
                <label for="referral_share_template">Template da Mensagem</label>
                <textarea id="referral_share_template" name="template" rows="20" style="font-family: monospace;">{{ referral_share_template }}</textarea>
            </div>
            <div style="display: flex; gap: 10px;">
                <button type="submit" class="btn btn-primary">ğŸ’¾ Salvar Template</button>
                <button type="button" class="btn btn-secondary" onclick="resetTemplate('referral_share_invitation')">ğŸ”„ Restaurar PadrÃ£o</button>
            </div>
        </form>
    </div>

    {% endif %}
</div>

<script>
    // Check status on page load
    document.addEventListener('DOMContentLoaded', function() {
        checkStatus();
    });

    function showAlert(message, type = 'success') {
        const container = document.getElementById('alert-container');
        const alert = document.createElement('div');
        alert.className = `alert alert-${type}`;
        alert.textContent = message;
        container.appendChild(alert);

        setTimeout(() => {
            alert.remove();
        }, 5000);
    }

    async function checkStatus() {
        const indicator = document.getElementById('status-indicator');
        const text = document.getElementById('status-text');
        const state = document.getElementById('connection-state');

        indicator.className = 'status-indicator loading';
        text.textContent = 'Verificando...';

        try {
            const response = await fetch('{% url "whatsapp_status" %}');
            const data = await response.json();

            if (data.success) {
                const status = data.status;
                const isConnected = status.state === 'open';

                indicator.className = `status-indicator ${isConnected ? 'connected' : 'disconnected'}`;
                text.textContent = isConnected ? 'âœ… Conectado' : 'âŒ Desconectado';
                state.textContent = status.state || 'Desconhecido';

                if (!isConnected) {
                    showAlert('WhatsApp nÃ£o estÃ¡ conectado. Clique em "Mostrar QR Code" para conectar.', 'warning');
                }
            } else {
                indicator.className = 'status-indicator disconnected';
                text.textContent = 'âŒ Erro ao verificar status';
                state.textContent = 'Erro';
                showAlert(data.error || 'Erro ao verificar status', 'error');
            }
        } catch (error) {
            indicator.className = 'status-indicator disconnected';
            text.textContent = 'âŒ Erro de conexÃ£o';
            state.textContent = 'Erro';
            showAlert('Erro ao conectar com a API: ' + error.message, 'error');
        }
    }

    async function showQRCode() {
        const card = document.getElementById('qrcode-card');
        const image = document.getElementById('qrcode-image');

        card.classList.remove('hidden');
        image.src = '';
        image.alt = 'Gerando QR Code...';

        try {
            const response = await fetch('{% url "whatsapp_qrcode" %}');
            const data = await response.json();

            if (data.success && data.qrcode) {
                image.src = data.qrcode;
                image.alt = 'QR Code WhatsApp';
                showAlert('QR Code gerado! Escaneie com seu WhatsApp.', 'success');
            } else {
                card.classList.add('hidden');
                showAlert(data.error || 'Erro ao gerar QR Code', 'error');
            }
        } catch (error) {
            card.classList.add('hidden');
            showAlert('Erro ao gerar QR Code: ' + error.message, 'error');
        }
    }

    async function restartInstance() {
        if (!confirm('Deseja realmente reiniciar a instÃ¢ncia WhatsApp?')) {
            return;
        }

        try {
            const response = await fetch('{% url "whatsapp_restart" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            });
            const data = await response.json();

            if (data.success) {
                showAlert(data.message, 'success');
                setTimeout(checkStatus, 2000);
            } else {
                showAlert(data.error || 'Erro ao reiniciar instÃ¢ncia', 'error');
            }
        } catch (error) {
            showAlert('Erro ao reiniciar instÃ¢ncia: ' + error.message, 'error');
        }
    }

    async function logoutInstance() {
        if (!confirm('Deseja realmente desconectar o WhatsApp? VocÃª precisarÃ¡ escanear o QR Code novamente.')) {
            return;
        }

        try {
            const response = await fetch('{% url "whatsapp_logout" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            });
            const data = await response.json();

            if (data.success) {
                showAlert(data.message, 'success');
                setTimeout(checkStatus, 2000);
            } else {
                showAlert(data.error || 'Erro ao desconectar', 'error');
            }
        } catch (error) {
            showAlert('Erro ao desconectar: ' + error.message, 'error');
        }
    }

    async function sendTestMessage(event) {
        event.preventDefault();

        const form = event.target;
        const formData = new FormData(form);
        const button = form.querySelector('button[type="submit"]');

        button.disabled = true;
        button.textContent = 'ğŸ“¤ Enviando...';

        try {
            const response = await fetch('{% url "whatsapp_test_message" %}', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (data.success) {
                showAlert(data.message, 'success');
                form.reset();
            } else {
                showAlert(data.error || 'Erro ao enviar mensagem', 'error');
            }
        } catch (error) {
            showAlert('Erro ao enviar mensagem: ' + error.message, 'error');
        } finally {
            button.disabled = false;
            button.textContent = 'ğŸ“¤ Enviar Mensagem';
        }
    }

    async function saveTemplate(event, templateName) {
        event.preventDefault();

        const form = event.target;
        const formData = new FormData(form);
        formData.append('template_name', templateName);
        
        const button = form.querySelector('button[type="submit"]');

        button.disabled = true;
        button.textContent = 'ğŸ’¾ Salvando...';

        try {
            const response = await fetch('{% url "whatsapp_save_template" %}', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (data.success) {
                showAlert(data.message, 'success');
            } else {
                showAlert(data.error || 'Erro ao salvar template', 'error');
            }
        } catch (error) {
            showAlert('Erro ao salvar template: ' + error.message, 'error');
        } finally {
            button.disabled = false;
            button.textContent = 'ğŸ’¾ Salvar Template';
        }
    }

    function resetTemplate(templateName) {
        if (!confirm('Deseja realmente restaurar o template padrÃ£o? As alteraÃ§Ãµes nÃ£o salvas serÃ£o perdidas.')) {
            return;
        }

        let defaultTemplate, fieldId;
        
        if (templateName === 'payment_confirmation') {
            fieldId = 'template';
            defaultTemplate = `ğŸ‰ *Pagamento Confirmado!*

OlÃ¡ *{name}*!

Seu pagamento foi aprovado com sucesso!

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ« *Rifa:* {raffle_name}
ğŸ† *PrÃªmio:* {prize_name}
{draw_date}

ğŸ”¢ *Seus nÃºmeros da sorte:*
{numbers}

ğŸ’° *Valor pago:* R$ {amount}
ğŸ“¦ *Pedido:* #{order_id}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ… Seus nÃºmeros estÃ£o reservados e concorrendo ao prÃªmio!

Boa sorte! ğŸ€âœ¨`;
        } else if (templateName === 'referral_bonus_notification') {
            fieldId = 'referral_template';
            defaultTemplate = `ğŸ‰ *ParabÃ©ns! IndicaÃ§Ã£o Confirmada!* ğŸ‰

OlÃ¡ *{inviter_name}*!

Ã“tima notÃ­cia! *{invitee_name}* acabou de concluir a compra usando seu link de indicaÃ§Ã£o!

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ« *Campanha:* {raffle_name}
ğŸ‘¤ *Quem comprou:* {invitee_name}
ğŸ’° *Quantidade:* {invitee_quantity} nÃºmeros

ğŸ *VocÃª ganhou {total_bonus} nÃºmeros grÃ¡tis!*
({bonus_breakdown})

ğŸ”¢ *Seus nÃºmeros de bÃ´nus:*
{bonus_numbers}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ¨ Continue indicando amigos e ganhe mais nÃºmeros!
Cada indicaÃ§Ã£o bem-sucedida te dÃ¡ mais chances de ganhar! ğŸ€`;
        } else if (templateName === 'referral_share_invitation') {
            fieldId = 'referral_share_template';
            defaultTemplate = `ğŸ *Ganhe NÃºmeros GrÃ¡tis Indicando Amigos!* ğŸ

OlÃ¡ *{name}*!

VocÃª sabia que pode ganhar *{inviter_bonus} nÃºmeros grÃ¡tis* a cada amigo que comprar usando seu link?

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ« *Campanha:* {raffle_name}
ğŸ† *PrÃªmio:* {prize_name}

ğŸ *Como funciona:*
â€¢ Compartilhe seu link personalizado
â€¢ Seu amigo ganha *{invitee_bonus} nÃºmeros extras*
â€¢ VocÃª ganha *{inviter_bonus} nÃºmeros grÃ¡tis*{progressive_message}

ğŸ”— *Seu link de indicaÃ§Ã£o:*
{referral_link}

ğŸ“Š *Suas indicaÃ§Ãµes:*
â€¢ {successful_referrals} pessoas jÃ¡ compraram com seu link
â€¢ {total_bonus_earned} nÃºmeros de bÃ´nus ganhos
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ’¡ *Dica:* Copie o link acima e compartilhe no WhatsApp, Instagram ou Facebook!

Quanto mais vocÃª indica, mais chances de ganhar! ğŸ€âœ¨`;
            // Reset delay field for referral share
            document.getElementById('referral_share_delay').value = 30;
        }

        document.getElementById(fieldId).value = defaultTemplate;
        showAlert('Template restaurado! NÃ£o esqueÃ§a de clicar em "Salvar Template" para aplicar.', 'warning');
    }

    // Auto-refresh status every 30 seconds
    setInterval(checkStatus, 30000);
</script>
{% endblock %}
