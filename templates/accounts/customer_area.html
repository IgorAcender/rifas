{% extends 'customer_base.html' %}

{% block title %}Minha √Årea{% endblock %}

{% block content %}
<div class="section-title">
    <h2>Minhas Campanhas</h2>
    <p class="subtitle">Rifas das quais voc√™ est√° participando, agrupadas por campanha</p>
</div>

<div class="raffles-section">
    {% regroup my_orders|dictsort:"raffle.name" by raffle as raffle_groups %}

    {% for raffle_group in raffle_groups %}
    {% with paid_orders=raffle_group.list|selectattr:"status","equalto","paid"|list %}
    {% if paid_orders %}
    <div class="campaign-group">
        <div class="campaign-group-header">
            <div class="campaign-group-title">
                <h3>{{ raffle_group.grouper.name }}</h3>
                <span class="campaign-group-badge">{{ raffle_group.grouper.get_status_display }}</span>
            </div>
            <div class="campaign-group-prize">
                <span class="prize-icon">üèÜ</span>
                <span class="prize-name">{{ raffle_group.grouper.prize_name }}</span>
            </div>
            {% if raffle_group.grouper.draw_date %}
            <div class="campaign-group-date">
                <span class="date-icon">üìÖ</span>
                <span>Sorteio: {{ raffle_group.grouper.draw_date|date:"d/m/Y √†s H:i" }}</span>
            </div>
            {% endif %}
        </div>

        <div class="campaign-group-stats">
            {% with total_quantity=0 total_amount=0 %}
            {% for order in paid_orders %}
                {% with total_quantity=total_quantity|add:order.quantity %}
                {% endwith %}
                {% with total_amount=total_amount|add:order.amount %}
                {% endwith %}
            {% endfor %}

            <div class="stat-card">
                <div class="stat-icon">üé´</div>
                <div class="stat-content">
                    <div class="stat-value">{{ paid_orders|sum:"quantity" }}</div>
                    <div class="stat-label">Meus n√∫meros</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üí∞</div>
                <div class="stat-content">
                    <div class="stat-value">R$ {{ paid_orders|sum:"amount"|floatformat:2 }}</div>
                    <div class="stat-label">Investido</div>
                </div>
            </div>
            {% endwith %}
        </div>
    </div>
    {% endif %}
    {% endwith %}
    {% empty %}
    <div class="empty-state">
        <div class="empty-icon">üé´</div>
        <h3>Nenhuma campanha ativa</h3>
        <p>Voc√™ ainda n√£o est√° participando de nenhuma rifa.</p>
    </div>
    {% endfor %}
</div>

{% if my_referral_codes %}
<div class="section-title">
    <h2>Compartilhar Link de Indica√ß√£o</h2>
    <p class="subtitle">Compartilhe o link das campanhas onde voc√™ comprou 10+ bilhetes</p>
</div>

<div class="share-referral-section">
    {% for referral in my_referral_codes %}
    <div class="share-card">
        <div class="share-header">
            <div class="share-icon">üîó</div>
            <div class="share-info">
                <h4>{{ referral.raffle.name }}</h4>
                <p class="share-stats">{{ referral.total_tickets }} bilhetes comprados ‚Ä¢ {{ referral.clicks }} cliques no link ‚Ä¢ Ganhe {{ referral.raffle.inviter_bonus }} n√∫meros gr√°tis por indica√ß√£o</p>
            </div>
        </div>
        <div class="share-content">
            <div class="share-link-wrapper">
                <input
                    type="text"
                    class="share-link-input"
                    value="{{ request.scheme }}://{{ request.get_host }}{{ referral.raffle.get_public_url }}?ref={{ referral.code }}"
                    readonly
                    id="referral-link-{{ referral.id }}"
                >
            </div>
            <div class="share-buttons">
                <button class="btn-copy" onclick="copyReferralLink('referral-link-{{ referral.id }}')">
                    üìã Copiar Link
                </button>
                <button class="btn-share" onclick="shareReferral('{{ request.scheme }}://{{ request.get_host }}{{ referral.raffle.get_public_url }}?ref={{ referral.code }}', '{{ referral.raffle.name }}')">
                    üì§ Compartilhar
                </button>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<div class="section-title">
    <h2>Minhas Indica√ß√µes</h2>
    <p class="subtitle">Pessoas que usaram seu link e completaram compra, agrupadas por campanha</p>
</div>

<div class="referrals-section">
    {% if my_referrals_grouped %}
    {% for group in my_referrals_grouped %}
    <div class="campaign-referral-group">
        <div class="campaign-header">
            <div class="campaign-title">
                <h3>{{ group.raffle.name }}</h3>
                <span class="campaign-stats">{{ group.count }} indica√ß√µes ‚Ä¢ {{ group.bonus_numbers }} n√∫meros b√¥nus ganhos</span>
            </div>
            <div class="campaign-badge">
                üéØ {{ group.raffle.get_status_display }}
            </div>
        </div>

        <div class="referrals-list">
            {% for referral in group.referrals %}
            <div class="referral-card">
                <div class="referral-avatar">üë§</div>
                <div class="referral-info">
                    <div class="referral-name">{{ referral.invitee.name }}</div>
                    <div class="referral-details">
                        <span class="referral-phone">{{ referral.invitee.whatsapp }}</span>
                        <span class="referral-separator">‚Ä¢</span>
                        <span class="referral-date">{{ referral.redeemed_at|date:"d/m/Y" }}</span>
                    </div>
                </div>
                <div class="referral-badge">
                    ‚úÖ Resgatou seu bilhete
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
    {% else %}
    <div class="empty-state">
        <div class="empty-icon">üîó</div>
        <h3>Nenhuma indica√ß√£o ainda</h3>
        <p>Compartilhe seu link de indica√ß√£o ap√≥s fazer uma compra e ganhe n√∫meros gr√°tis!</p>
    </div>
    {% endif %}
</div>

<div class="section-title">
    <h2>Meus N√∫meros</h2>
    <p class="subtitle">Todos os seus n√∫meros da sorte</p>
</div>

<div class="numbers-grid">
    {% for number in my_numbers %}
    <div class="number-card">
        <div class="raffle-name">{{ number.raffle.name }}</div>
        <div class="number-display">{{ number.number|stringformat:"04d" }}</div>
        <div class="number-status status-{{ number.status }}">
            {{ number.get_status_display }}
        </div>
        {% if number.source != 'purchase' %}
        <div class="bonus-badge">üéÅ {{ number.get_source_display }}</div>
        {% endif %}
    </div>
    {% empty %}
    <p class="empty-state">Voce ainda nao possui numeros. Faca sua primeira compra!</p>
    {% endfor %}
</div>

<div class="section-title">
    <h2>Hist√≥rico de Compras</h2>
    <p class="subtitle">Todas as suas transa√ß√µes</p>
</div>

<div class="orders-list">
    {% for order in my_orders %}
    <div class="order-card">
        <div class="order-header">
            <div class="order-title">
                <h3>{{ order.raffle.name }}</h3>
                <span class="order-date">{{ order.created_at|date:"d/m/Y √†s H:i" }}</span>
            </div>
            <span class="order-status status-{{ order.status }}">
                {{ order.get_status_display }}
            </span>
        </div>
        <div class="order-details">
            <div class="detail-item">
                <span class="detail-label">Quantidade:</span>
                <span class="detail-value">{{ order.quantity }} n√∫meros</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Valor:</span>
                <span class="detail-value">R$ {{ order.amount }}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Pedido:</span>
                <span class="detail-value">#{{ order.id }}</span>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="empty-state">
        <div class="empty-icon">üì¶</div>
        <h3>Nenhuma compra realizada</h3>
        <p>Seu hist√≥rico aparecer√° aqui.</p>
    </div>
    {% endfor %}
</div>

<style>
/* Section Title */
.section-title {
    margin: 40px 0 24px;
}

.section-title:first-child {
    margin-top: 0;
}

.section-title h2 {
    font-size: 24px;
    font-weight: 600;
    color: #1e293b;
    margin-bottom: 4px;
}

.section-title .subtitle {
    font-size: 14px;
    color: #64748b;
}

/* Raffles Section - Grouped by Campaign */
.raffles-section {
    margin-bottom: 40px;
}

.campaign-group {
    background: white;
    border: 1px solid #e5e5e5;
    border-radius: 12px;
    margin-bottom: 24px;
    overflow: hidden;
}

.campaign-group-header {
    background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    padding: 20px 24px;
    color: white;
}

.campaign-group-title {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.campaign-group-title h3 {
    font-size: 20px;
    font-weight: 600;
    margin: 0;
}

.campaign-group-badge {
    padding: 6px 12px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    white-space: nowrap;
}

.campaign-group-prize {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
}

.prize-icon {
    font-size: 20px;
}

.prize-name {
    font-size: 14px;
    opacity: 0.9;
}

.campaign-group-date {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    opacity: 0.9;
}

.date-icon {
    font-size: 16px;
}

.campaign-group-stats {
    padding: 20px 24px;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
}

.stat-card {
    background: #f8fafc;
    border: 1px solid #e5e5e5;
    border-radius: 8px;
    padding: 16px;
    display: flex;
    align-items: center;
    gap: 16px;
}

.stat-icon {
    font-size: 32px;
}

.stat-content {
    flex: 1;
}

.stat-value {
    font-size: 24px;
    font-weight: 700;
    color: #22c55e;
    margin-bottom: 4px;
}

.stat-label {
    font-size: 13px;
    color: #64748b;
    font-weight: 500;
}

/* Numbers Grid */

.numbers-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: 16px;
    margin-bottom: 40px;
}

.number-card {
    background: white;
    border: 2px solid #e5e5e5;
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    transition: all 0.2s;
}

.number-card:hover {
    border-color: #22c55e;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(34, 197, 94, 0.15);
}

.raffle-name {
    font-size: 11px;
    color: #64748b;
    margin-bottom: 12px;
    text-transform: uppercase;
    font-weight: 600;
}

.number-display {
    font-size: 36px;
    font-weight: 700;
    color: #1e293b;
    margin-bottom: 12px;
    font-family: monospace;
}

.number-status {
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
    display: inline-block;
    text-transform: uppercase;
}

.status-vendido {
    background: #dcfce7;
    color: #16a34a;
}

.status-reserved {
    background: #fef3c7;
    color: #d97706;
}

.bonus-badge {
    margin-top: 8px;
    font-size: 11px;
    color: #ef4444;
    font-weight: 600;
}

/* Orders List */
.orders-list {
    display: flex;
    flex-direction: column;
    gap: 16px;
    margin-bottom: 40px;
}

.order-card {
    background: white;
    border: 1px solid #e5e5e5;
    border-radius: 12px;
    padding: 20px;
    transition: all 0.2s;
}

.order-card:hover {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.order-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 16px;
    padding-bottom: 16px;
    border-bottom: 1px solid #e5e5e5;
}

.order-title h3 {
    font-size: 16px;
    font-weight: 600;
    color: #1e293b;
    margin-bottom: 4px;
}

.order-date {
    font-size: 12px;
    color: #94a3b8;
}

.order-status {
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
}

.status-paid {
    background: #dcfce7;
    color: #16a34a;
}

.status-pending {
    background: #fef3c7;
    color: #d97706;
}

.status-cancelled {
    background: #fee2e2;
    color: #dc2626;
}

.order-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 12px;
}

.detail-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    background: #f8fafc;
    border-radius: 6px;
}

.detail-label {
    font-size: 13px;
    color: #64748b;
    font-weight: 500;
}

.detail-value {
    font-size: 13px;
    color: #1e293b;
    font-weight: 600;
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 60px 20px;
    grid-column: 1 / -1;
}

.empty-icon {
    font-size: 64px;
    margin-bottom: 16px;
    opacity: 0.5;
}

.empty-state h3 {
    font-size: 18px;
    font-weight: 600;
    color: #1e293b;
    margin-bottom: 8px;
}

.empty-state p {
    font-size: 14px;
    color: #94a3b8;
}

/* Referrals Section */
.referrals-section {
    margin-bottom: 40px;
}

.campaign-referral-group {
    background: white;
    border: 1px solid #e5e5e5;
    border-radius: 12px;
    margin-bottom: 24px;
    overflow: hidden;
}

.campaign-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 20px 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: white;
}

.campaign-title h3 {
    font-size: 20px;
    font-weight: 600;
    margin: 0 0 4px 0;
}

.campaign-stats {
    font-size: 13px;
    opacity: 0.9;
}

.campaign-badge {
    padding: 6px 12px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    white-space: nowrap;
}

.referrals-list {
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.referral-card {
    background: #f8fafc;
    border: 1px solid #e5e5e5;
    border-radius: 8px;
    padding: 16px;
    display: flex;
    align-items: center;
    gap: 16px;
    transition: all 0.2s;
}

.referral-card:hover {
    background: white;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    border-color: #667eea;
}

.referral-avatar {
    font-size: 32px;
    width: 48px;
    height: 48px;
    background: #f1f5f9;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.referral-info {
    flex: 1;
}

.referral-name {
    font-size: 16px;
    font-weight: 600;
    color: #1e293b;
    margin-bottom: 4px;
}

.referral-details {
    font-size: 13px;
    color: #64748b;
    display: flex;
    align-items: center;
    gap: 8px;
}

.referral-separator {
    color: #cbd5e1;
}

.referral-badge {
    padding: 8px 16px;
    background: #dcfce7;
    color: #16a34a;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    white-space: nowrap;
}

@media (max-width: 768px) {
    .campaign-group-title {
        flex-direction: column;
        align-items: start;
        gap: 8px;
    }

    .campaign-group-badge {
        align-self: stretch;
        text-align: center;
    }

    .campaign-group-stats {
        grid-template-columns: 1fr;
    }

    .campaign-header {
        flex-direction: column;
        align-items: start;
        gap: 12px;
    }

    .campaign-badge {
        align-self: stretch;
        text-align: center;
    }

    .referral-card {
        flex-direction: column;
        align-items: start;
        gap: 12px;
    }

    .referral-badge {
        align-self: stretch;
        text-align: center;
    }
}

/* Share Referral Section */
.share-referral-section {
    margin-bottom: 40px;
}

.share-card {
    background: white;
    border: 1px solid #e5e5e5;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 16px;
    transition: all 0.2s;
}

.share-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    border-color: #22c55e;
}

.share-header {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 20px;
}

.share-icon {
    font-size: 32px;
    width: 56px;
    height: 56px;
    background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.share-info {
    flex: 1;
}

.share-info h4 {
    font-size: 18px;
    font-weight: 600;
    color: #1e293b;
    margin-bottom: 4px;
}

.share-stats {
    font-size: 13px;
    color: #64748b;
    margin: 0;
}

.share-content {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.share-link-wrapper {
    width: 100%;
}

.share-link-input {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid #e5e5e5;
    border-radius: 8px;
    font-size: 14px;
    font-family: monospace;
    color: #1e293b;
    background: #f8fafc;
    transition: all 0.2s;
}

.share-link-input:focus {
    outline: none;
    border-color: #22c55e;
    background: white;
}

.share-buttons {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}

.btn-copy,
.btn-share {
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-copy {
    background: #f1f5f9;
    color: #1e293b;
}

.btn-copy:hover {
    background: #e2e8f0;
    transform: translateY(-1px);
}

.btn-share {
    background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    color: white;
}

.btn-share:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
}

@media (max-width: 768px) {
    .share-buttons {
        grid-template-columns: 1fr;
    }

    .share-header {
        flex-direction: column;
        align-items: start;
    }

    .share-icon {
        width: 48px;
        height: 48px;
        font-size: 28px;
    }
}
</style>

<script>
function copyReferralLink(inputId) {
    const input = document.getElementById(inputId);

    // Try modern clipboard API first
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(input.value).then(() => {
            showCopySuccess();
        }).catch(() => {
            fallbackCopy(input);
        });
    } else {
        fallbackCopy(input);
    }
}

function fallbackCopy(input) {
    input.select();
    input.setSelectionRange(0, 99999); // For mobile

    try {
        document.execCommand('copy');
        showCopySuccess();
    } catch (err) {
        alert('Erro ao copiar. Por favor, copie manualmente.');
    }
}

function showCopySuccess() {
    // Create temporary success message
    const message = document.createElement('div');
    message.textContent = '‚úÖ Link copiado!';
    message.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #22c55e;
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        z-index: 10000;
        animation: slideIn 0.3s ease-out;
    `;

    document.body.appendChild(message);

    setTimeout(() => {
        message.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => message.remove(), 300);
    }, 2000);
}

function shareReferral(link, raffleName) {
    const shareData = {
        title: 'Participe da Rifa!',
        text: `Participe da rifa "${raffleName}" usando meu link e ganhe n√∫meros gr√°tis!`,
        url: link
    };

    // Check if Web Share API is available
    if (navigator.share) {
        navigator.share(shareData)
            .then(() => console.log('Shared successfully'))
            .catch((error) => {
                // If user cancels, just do nothing
                if (error.name !== 'AbortError') {
                    fallbackShare(link);
                }
            });
    } else {
        fallbackShare(link);
    }
}

function fallbackShare(link) {
    // Copy to clipboard as fallback
    navigator.clipboard.writeText(link).then(() => {
        alert('Link copiado! Cole e compartilhe onde preferir.');
    }).catch(() => {
        alert('Compartilhamento n√£o dispon√≠vel. Use o bot√£o "Copiar Link".');
    });
}

// Add CSS animation
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from {
            transform: translateX(400px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(400px);
            opacity: 0;
        }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}
