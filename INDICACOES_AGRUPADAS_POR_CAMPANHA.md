# âœ… IndicaÃ§Ãµes Agrupadas por Campanha

## O que mudou

A seÃ§Ã£o "Minhas IndicaÃ§Ãµes" agora mostra as pessoas que usaram seu link **agrupadas por campanha**, com estatÃ­sticas individuais para cada uma.

---

## Visual Novo

### Antes (lista Ãºnica):
```
Minhas IndicaÃ§Ãµes
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ‘¤ Maria Silva
   Campanha A â€¢ 10/11/2025
   âœ… Resgatou seu bilhete

ğŸ‘¤ Pedro Santos
   Campanha B â€¢ 09/11/2025
   âœ… Resgatou seu bilhete

ğŸ‘¤ JoÃ£o Costa
   Campanha A â€¢ 08/11/2025
   âœ… Resgatou seu bilhete
```

### Agora (agrupado por campanha):
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Campanha A                                     ğŸ¯ Ativa     â”‚
â”‚ 2 indicaÃ§Ãµes â€¢ 4 nÃºmeros bÃ´nus ganhos                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ‘¤ Maria Silva                                              â”‚
â”‚    5511999999999 â€¢ 10/11/2025  âœ… Resgatou seu bilhete     â”‚
â”‚                                                             â”‚
â”‚ ğŸ‘¤ JoÃ£o Costa                                               â”‚
â”‚    5511888888888 â€¢ 08/11/2025  âœ… Resgatou seu bilhete     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Campanha B                                     ğŸ¯ Ativa     â”‚
â”‚ 1 indicaÃ§Ã£o â€¢ 2 nÃºmeros bÃ´nus ganhos                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ‘¤ Pedro Santos                                             â”‚
â”‚    5511777777777 â€¢ 09/11/2025  âœ… Resgatou seu bilhete     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## InformaÃ§Ãµes Exibidas

### Por campanha:
- **Nome da campanha**
- **Status da campanha** (Ativa, Finalizada, etc.)
- **Total de indicaÃ§Ãµes** nessa campanha especÃ­fica
- **NÃºmeros bÃ´nus ganhos** nessa campanha especÃ­fica

### Por pessoa (dentro de cada campanha):
- **Nome** do indicado
- **WhatsApp** do indicado
- **Data** que completou a compra
- **Badge de confirmaÃ§Ã£o**: âœ… Resgatou seu bilhete

---

## ImplementaÃ§Ã£o Backend

### `accounts/views.py`

```python
# Buscar todas as indicaÃ§Ãµes bem-sucedidas
all_referrals = Referral.objects.filter(
    inviter=request.user,
    status=Referral.Status.REDEEMED
).select_related('invitee', 'raffle').order_by('raffle', '-redeemed_at')

# Agrupar por campanha usando defaultdict
referrals_by_raffle = defaultdict(list)
for referral in all_referrals:
    referrals_by_raffle[referral.raffle].append(referral)

# Criar estrutura para o template
my_referrals_grouped = []
for raffle, referrals in referrals_by_raffle.items():
    # Contar nÃºmeros bÃ´nus DESTA campanha especÃ­fica
    bonus_count = RaffleNumber.objects.filter(
        user=request.user,
        raffle=raffle,
        source=RaffleNumber.Source.REFERRAL_INVITER
    ).count()

    my_referrals_grouped.append({
        'raffle': raffle,              # Objeto da campanha
        'referrals': referrals,        # Lista de indicaÃ§Ãµes
        'count': len(referrals),       # Total de indicaÃ§Ãµes
        'bonus_numbers': bonus_count   # NÃºmeros bÃ´nus ganhos
    })
```

**Estrutura de dados:**
```python
my_referrals_grouped = [
    {
        'raffle': <Raffle: Campanha A>,
        'referrals': [
            <Referral: Maria>,
            <Referral: JoÃ£o>
        ],
        'count': 2,
        'bonus_numbers': 4
    },
    {
        'raffle': <Raffle: Campanha B>,
        'referrals': [
            <Referral: Pedro>
        ],
        'count': 1,
        'bonus_numbers': 2
    }
]
```

---

## Template HTML

```html
{% for group in my_referrals_grouped %}
<div class="campaign-referral-group">
    <!-- CabeÃ§alho da campanha (roxo) -->
    <div class="campaign-header">
        <div class="campaign-title">
            <h3>{{ group.raffle.name }}</h3>
            <span class="campaign-stats">
                {{ group.count }} indicaÃ§Ãµes â€¢
                {{ group.bonus_numbers }} nÃºmeros bÃ´nus ganhos
            </span>
        </div>
        <div class="campaign-badge">
            ğŸ¯ {{ group.raffle.get_status_display }}
        </div>
    </div>

    <!-- Lista de pessoas que usaram o link -->
    <div class="referrals-list">
        {% for referral in group.referrals %}
        <div class="referral-card">
            <div class="referral-avatar">ğŸ‘¤</div>
            <div class="referral-info">
                <div class="referral-name">{{ referral.invitee.name }}</div>
                <div class="referral-details">
                    <span>{{ referral.invitee.whatsapp }}</span>
                    <span>â€¢</span>
                    <span>{{ referral.redeemed_at|date:"d/m/Y" }}</span>
                </div>
            </div>
            <div class="referral-badge">
                âœ… Resgatou seu bilhete
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endfor %}
```

---

## Estilos CSS

### CabeÃ§alho da campanha:
```css
.campaign-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 20px 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: white;
}
```

### Cards de pessoas:
```css
.referral-card {
    background: #f8fafc;
    border: 1px solid #e5e5e5;
    border-radius: 8px;
    padding: 16px;
}

.referral-card:hover {
    background: white;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    border-color: #667eea;
}
```

---

## Exemplo PrÃ¡tico

### JoÃ£o tem indicaÃ§Ãµes em 3 campanhas:

**Campanha "Rifa do Carro":**
- Maria comprou em 10/11/2025
- Pedro comprou em 09/11/2025
- Carlos comprou em 08/11/2025
- **Total:** 3 indicaÃ§Ãµes, 6 nÃºmeros bÃ´nus

**Campanha "Rifa da Moto":**
- Ana comprou em 07/11/2025
- **Total:** 1 indicaÃ§Ã£o, 2 nÃºmeros bÃ´nus

**Campanha "Rifa do Celular":**
- Lucas comprou em 06/11/2025
- Julia comprou em 05/11/2025
- **Total:** 2 indicaÃ§Ãµes, 4 nÃºmeros bÃ´nus

### O que JoÃ£o vÃª:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Rifa do Carro                                  ğŸ¯ Ativa     â”‚
â”‚ 3 indicaÃ§Ãµes â€¢ 6 nÃºmeros bÃ´nus ganhos                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ‘¤ Maria Silva        5511999999999 â€¢ 10/11/2025           â”‚
â”‚ ğŸ‘¤ Pedro Santos       5511888888888 â€¢ 09/11/2025           â”‚
â”‚ ğŸ‘¤ Carlos Oliveira    5511777777777 â€¢ 08/11/2025           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Rifa da Moto                                   ğŸ¯ Ativa     â”‚
â”‚ 1 indicaÃ§Ã£o â€¢ 2 nÃºmeros bÃ´nus ganhos                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ‘¤ Ana Costa          5511666666666 â€¢ 07/11/2025           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Rifa do Celular                                ğŸ¯ Ativa     â”‚
â”‚ 2 indicaÃ§Ãµes â€¢ 4 nÃºmeros bÃ´nus ganhos                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ‘¤ Lucas Ferreira     5511555555555 â€¢ 06/11/2025           â”‚
â”‚ ğŸ‘¤ Julia Almeida      5511444444444 â€¢ 05/11/2025           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Vantagens do Agrupamento

### 1. **OrganizaÃ§Ã£o clara**
- FÃ¡cil ver quantas indicaÃ§Ãµes em cada campanha
- EstatÃ­sticas separadas por campanha

### 2. **Acompanhamento de desempenho**
- Ver qual campanha estÃ¡ gerando mais indicaÃ§Ãµes
- Comparar nÃºmeros bÃ´nus entre campanhas

### 3. **InformaÃ§Ã£o completa**
- Nome + WhatsApp de cada indicado
- Data exata da compra
- Status da campanha

### 4. **Melhor UX**
- NÃ£o precisa procurar pela campanha
- VisÃ£o geral imediata de cada campanha
- Cards organizados e fÃ¡ceis de ler

---

## OrdenaÃ§Ã£o

### Campanhas:
- Ordenadas pela **ordem em que aparecem** no banco de dados
- Pode ser customizado para ordenar por:
  - Mais indicaÃ§Ãµes primeiro
  - Mais recente primeiro
  - AlfabÃ©tica

### Pessoas (dentro de cada campanha):
- Ordenadas por **data de resgate** (mais recente primeiro)
- Ãšltima pessoa que comprou aparece no topo

---

## Responsividade

### Desktop:
- CabeÃ§alho horizontal (tÃ­tulo Ã  esquerda, badge Ã  direita)
- Cards de pessoas compactos

### Mobile:
- CabeÃ§alho vertical (badge abaixo do tÃ­tulo)
- Cards de pessoas empilhados
- Badge ocupa largura total

---

## Estado Vazio

Se nÃ£o houver indicaÃ§Ãµes em nenhuma campanha:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ğŸ”—                                   â”‚
â”‚                                                             â”‚
â”‚              Nenhuma indicaÃ§Ã£o ainda                        â”‚
â”‚                                                             â”‚
â”‚  Compartilhe seu link de indicaÃ§Ã£o apÃ³s fazer uma          â”‚
â”‚  compra e ganhe nÃºmeros grÃ¡tis!                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Dados Retornados

Para cada grupo de campanha:

```python
{
    'raffle': Raffle object,           # Objeto completo da campanha
    'referrals': [Referral objects],   # Lista de indicaÃ§Ãµes
    'count': 3,                        # Total de indicaÃ§Ãµes
    'bonus_numbers': 6                 # NÃºmeros bÃ´nus DESTA campanha
}
```

Para cada indicaÃ§Ã£o:

```python
{
    'invitee': User object,            # Pessoa que comprou
    'redeemed_at': datetime,           # Quando completou compra
    'raffle': Raffle object,           # Campanha (jÃ¡ vem do grupo)
}
```

---

## Queries no Banco

### Total de queries:
```
1. Buscar todas as indicaÃ§Ãµes do usuÃ¡rio
2. Para cada campanha Ãºnica:
   - Contar nÃºmeros bÃ´nus dessa campanha
```

**OtimizaÃ§Ã£o:**
- Usa `select_related('invitee', 'raffle')` para evitar N+1 queries
- Usa `defaultdict` para agrupar em memÃ³ria (rÃ¡pido)

---

## CustomizaÃ§Ãµes Futuras

### PossÃ­veis melhorias:

1. **OrdenaÃ§Ã£o customizada**
   ```python
   # Ordenar por quantidade de indicaÃ§Ãµes (maior primeiro)
   my_referrals_grouped.sort(key=lambda x: x['count'], reverse=True)
   ```

2. **Filtros**
   - Mostrar apenas campanhas ativas
   - Esconder campanhas sem indicaÃ§Ãµes

3. **EstatÃ­sticas extras**
   - MÃ©dia de indicaÃ§Ãµes por campanha
   - Taxa de conversÃ£o (cliques â†’ compras)

4. **AÃ§Ãµes por campanha**
   - BotÃ£o para compartilhar link daquela campanha
   - Ver detalhes da campanha

---

## Resumo

âœ… **IndicaÃ§Ãµes agrupadas** por campanha
âœ… **EstatÃ­sticas individuais** para cada campanha
âœ… **Lista completa** de pessoas que usaram o link
âœ… **InformaÃ§Ãµes detalhadas**: Nome, WhatsApp, Data
âœ… **Design limpo** com cabeÃ§alho roxo degradÃª
âœ… **Responsivo** para mobile
âœ… **Performance otimizada** com select_related

**O sistema estÃ¡ pronto para usar!** ğŸš€
